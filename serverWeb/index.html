<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src=/socket.io/socket.io.js></script>
    <script src=https://code.jquery.com/jquery-1.9.1.min.js></script>
    <script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script>
        
        // Iniciando Socket Client
        var socket = io.connect();
        var isServ ;
        var adressLocal = 'http://localhost:3012';
        var adressWeb   = 'http://skt-test.herokuapp.com/';
        //var adressWeb   = 'http://localhost:3000';
        
        //isServer é emitido no load da pagina
        socket.on('isServer', function(objSocketidClient){

            if(objSocketidClient.sessionid){
                $('#btnEnviarId').hide();
                $('#btnLigar').show();
                $('#mensagem').css("color","#0000FF"); 
                $('#mensagem').text('Instância client remoto Execute uma ação abaixo:');
                isServ = false;  
            };
        
        });  

        socket.on('pong', function(data){
            
            if(isServ){
                EnviaPost({"sessionid":socket.id});
            }
            
            socket.emit('ping', {"sessionid":socket.id});
            
            sleep(2000);            
            
        });             

        socket.on('ligar', function(objSocketidClient){
            
            if(!objSocketidClient)
                return;
            
            //Aqui eu comparo se o socketIdClient gravado é da master
            if(socket.id === objSocketidClient.sessionid){
                
                $('#log').html($('#log').html() + '<br>' + 'On ' + Date());

                // envia um post maroto local service node.js ajax
                $.ajax ({
                    url: adressLocal,
                    type: "GET",
                    data: JSON.stringify({data:"test"}),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function(lblLigou){
                        if(lblLigou.acendeu)
                            //alert('Acendeu');
                            $('#log').html($('#log').html() + '<br>' + 'Acendeu ' + Date());
                    }
                }); 
                         
            };      
        });
        
        function EnviaPost(sessionID){
            
            $.ajax ({
                url: adressWeb,
                type: "POST",
                data: JSON.stringify(sessionID),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function(lblLigou){
                    if(lblLigou == 'Setado')
                        $('#log').html($('#log').html() + '<br>' + 'Postou ID! ' + Date());
                }
            });            
        } 
    
        $(function(){
            
            $('#btnEnviarId').click(function(){
                isServ = true;
                socket.emit('ping', {});
                $('#btnEnviarId').hide();
                $('#btnErase').show();
                return false;
            });

            $('#btnLigar').click(function(){
                socket.emit('ligar', socket.id);
                return false;
            }); 
            
            $('#btnLigar').hide();
            $('#btnErase').hide();
            $('#mensagem').css("color","#FF0000");   
            $('#mensagem').text('Instância client/server não fechar essa aba do navegador. App socket rodando...');  
        
            //socket.emit('ping', {});
        });
        
        function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds){
                break;
                }
            }
        };         
            
    </script>
  </head>
  <body>
    <div class="container-fluid">
        <p id="mensagem"></p>
        <input type="button" class="btn btn-primary btn-large" value="Autenticar socket.id no servidor" id="btnEnviarId" >
        <input type="button" class="btn btn-primary btn-large" value="Ligar Dispositivo Remoto" id="btnLigar" >
        <p id="log"></p>
    </div>
  </body>
</html>