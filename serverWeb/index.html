<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src=/socket.io/socket.io.js></script>
    <script src=https://code.jquery.com/jquery-1.9.1.min.js></script>
    <script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script>
        /*
        Script em Js NodeJs Adaptado por Juscilan Moreto
        Responsavel por implementar rotas e socket.io server
        2016 © - juscilan.com‎
        */
        
        
        // Iniciando Socket Client
        var socket = io.connect();
        var isServ ;
        var adressLocal = 'http://localhost:3012';
        var adressWeb   = 'http://skt-test.herokuapp.com/';
        //var adressWeb   = 'http://localhost:3000';
        
        //Objeto js executar as acoes:
        var objAcoes = {
            ledon:false
            ,ledoff:false
            ,relon:false
            ,reloff:false
            ,socketid:''
        }
        
        //isServer é emitido no load da pagina
        socket.on('isServer', function(objSocketidClient){

            //se eu ja tiver a sessionid gravada trata-se de um client    
            if(objSocketidClient.sessionid){
                $('#btnEnviarId').hide();
                
                $('#btnLigarLed').show();
                $('#btnDeslLed').show();
                $('#btnLigarRele').show();
                $('#btnDeslRele').show();               
                
                $('#mensagem').css("color","#0000FF"); 
                $('#mensagem').html('Instância client remoto </br> Execute uma ação abaixo:');
                isServ = false;  
            }else{
                $('#btnEnviarId').show();
            };
        
        });  

        // Ping-pong utilizado para manter a conexão com o PaaS    
        socket.on('pong', function(){
            
            if(isServ){
                socket.emit('ping', {"sessionid":socket.id});
                EnviaPost({"sessionid":socket.id});
            }

        });             

        // Executa a ação Retorno
        socket.on('ExecActionBack', function(dataAction){
            
            //Aqui eu comparo se estou na instancia isServ e se tenho dataAction
            if(isServ && dataAction){    
                
                //Grava um log
                //$('#log').html($('#log').html() + '<br>' + 'On ' + Date());

                // envia um post para uma api rest LOCAL rodando node.js via ajax
                $.ajax ({
                    url: adressLocal,
                    type: "POST",
                    data: JSON.stringify(dataAction),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function(lblLigou){
                        if(lblLigou.exec)
                            $('#log').html($('#log').html() + '<br>' + 'Executou ' + Date() + ' Objeto: ' + JSON.stringify(dataAction));
                    }
                    /*
                    ,error: function(erro){
                        $('#log').html($('#log').html() + '<br>' + 'Erro ' + Date() + ' Objeto: ' + JSON.stringify(erro));
                    }*/
                }); 
                         
            };      
        });
        
        //Envia um post para o PaaS para manter a Session.id e a conexão...
        function EnviaPost(sessionID){
            
            $.ajax ({
                url: adressWeb,
                type: "POST",
                data: JSON.stringify(sessionID),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function(setado){
                    if(setado == 'Set ok')
                        $('#log').html($('#log').html() + '<br>' + 'Setado ID! ' + Date());
                }
            });            
        } 
    
        //Jquery onload
        $(function(){
            
            $('#btnEnviarId').click(function(){
                isServ = true;
                socket.emit('ping', {});
                $('#btnEnviarId').hide();
                $('#btnErase').show();
                return false;
            });

            //Acoes click botao    
            $('#btnLigarLed').click(function(){
                resetObject();
                objAcoes.ledon = true;
                objAcoes.socketid = socket.id;

                socket.emit('ExecAction', objAcoes);
                return false;
            }); 
            
            $('#btnDeslLed').click(function(){
                resetObject();
                objAcoes.ledoff = true;
                objAcoes.socketid = socket.id;

                socket.emit('ExecAction', objAcoes);
                return false;
            });
            
            $('#btnLigarRele').click(function(){
                resetObject();
                objAcoes.relon = true;
                objAcoes.socketid = socket.id;

                socket.emit('ExecAction', objAcoes);
                return false;
            }); 
            
            $('#btnDeslRele').click(function(){
                resetObject();
                objAcoes.reloff = true;
                objAcoes.socketid = socket.id;

                socket.emit('ExecAction', objAcoes);
                return false;
            });                          
            
            //Inicia os elementos html load
            $('#btnEnviarId').hide();

            $('#btnLigarLed').hide();
            $('#btnDeslLed').hide();
            $('#btnLigarRele').hide();
            $('#btnDeslRele').hide();

            $('#mensagem').css("color","#FF0000");   
            $('#mensagem').html('Instância bridge não fechar essa aba e nem recarregar. </br> App ponte socket rodando...');  

        });
        
        //função interna zerar o objeto
        function resetObject(){
            objAcoes = {
                ledon:false
                ,ledoff:false
                ,relon:false
                ,reloff:false
                ,socketid:''
            }                
        };                 
            
    </script>
  </head>
  <body>
    <div class="container-fluid">
        <p id="mensagem"></p>
        <input type="button" class="btn btn-primary btn-large" value="Startar Servidor PaaS" id="btnEnviarId" >
        <input type="button" class="btn btn-primary btn-large" value="Ligar Led " id="btnLigarLed" >
        <input type="button" class="btn btn-primary btn-large" value="Desligar Led" id="btnDeslLed" >
        <input type="button" class="btn btn-primary btn-large" value="Ligar Rele " id="btnLigarRele" >
        <input type="button" class="btn btn-primary btn-large" value="Desligar Rele" id="btnDeslRele" >        
        <p id="log"></p>
    </div>
  </body>
</html>