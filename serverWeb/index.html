<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src=/socket.io/socket.io.js></script>
    <script src=https://code.jquery.com/jquery-1.9.1.min.js></script>
    <script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script>
        /*
        Script em Js NodeJs Adaptado por Juscilan Moreto
        Responsavel por implementar rotas e socket.io server
        2016 © - juscilan.com‎
        */
        
        // Iniciando Socket Client
        var socket = io.connect();
        var isServ ;
        var adressLocal = 'http://localhost:3012';
        var adressWeb   = 'http://skt-test.herokuapp.com/';
        //var adressWeb   = 'http://localhost:3000';
        
        //Objeto js executar as acoes:
        var objAcoes = {
            ledon:false
            ,ledoff:false
            ,relon:false
            ,reloff:false
        }
        
        //Objeto post Ajax
        var objPost = {
            url:''
            ,data:{}
        }        
        
        //isServer é emitido pelo socket.io no load da pagina
        socket.on('isServer', function(objSocketidClient){

            //se eu ja tiver a sessionid gravada trata-se de um client    
            if(objSocketidClient.sessionid){
                $('#btnEnviarId').hide();
                
                $('#btnLigarLed').show();
                $('#btnDeslLed').show();
                $('#btnLigarRele').show();
                $('#btnDeslRele').show();               
                
                $('#mensagem').show(); 
                $('#mensagem').css("color","#0000FF"); 
                $('#mensagem').html('Instância client remoto </br> Execute uma ação abaixo:');
                isServ = false;  
            }else{
                $('#btnEnviarId').show();
            };
        
        });  

        // Ping-pong utilizado para manter a conexão com o PaaS    
        socket.on('pong', function(){
            
            $('#mensagem').show(); 
            
            if(isServ){
                socket.emit('ping', {});
                objPost.url = adressWeb;
                objPost.data = {"sessionid":socket.id};
                enviaPost(objPost);
            }

        });             

        // Executa a ação Retorno
        socket.on('ExecActionBack', function(dataAction){
            //Aqui eu comparo se estou na instancia isServ e se tenho dataAction
            if(isServ && dataAction){    
                objPost.url = adressLocal;
                objPost.data = dataAction;
                enviaPost(objPost);
            };      
        });
        
        //Envia um post 
        function enviaPost(dataPost){
            
            $.ajax ({
                url: dataPost.url,
                type: "POST",
                data: JSON.stringify(dataPost.data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                /*
                success: function(dataAction){
                    if(dataAction)
                        $('#log').html($('#log').html() + '<br>' + 'Executou!  Objeto: ' + JSON.stringify(dataPost.data));
                }
                */

            });            
        }
    
        //Jquery onload
        $(function(){
            
            $('#btnEnviarId').click(function(){
                socket.emit('ping', {});
                isServ = true;
                $('#btnEnviarId').hide();
                return false;
            });

            //Acoes click botao    
            $('#btnLigarLed').click(function(){
                resetdataAction();
                objAcoes.ledon = true;

                socket.emit('ExecAction', objAcoes);
                return false;
            }); 
            
            $('#btnDeslLed').click(function(){
                resetdataAction();
                objAcoes.ledoff = true;

                socket.emit('ExecAction', objAcoes);
                return false;
            });
            
            $('#btnLigarRele').click(function(){
                resetdataAction();
                objAcoes.relon = true;

                socket.emit('ExecAction', objAcoes);
                return false;
            }); 
            
            $('#btnDeslRele').click(function(){
                resetdataAction();
                objAcoes.reloff = true;

                socket.emit('ExecAction', objAcoes);
                return false;
            });                          
            
            //Inicia os elementos html load
            $('#btnEnviarId').hide();

            $('#btnLigarLed').hide();
            $('#btnDeslLed').hide();
            $('#btnLigarRele').hide();
            $('#btnDeslRele').hide();

            $('#mensagem').css("color","#FF0000");
            $('#mensagem').html('Instância bridge não fechar essa aba e nem recarregar. </br> App ponte socket rodando...');  

        });
        
        //função interna zerar os valores do objeto
        function resetdataAction(){
            objAcoes = {
                ledon:false
                ,ledoff:false
                ,relon:false
                ,reloff:false
            }                
        };                 
            
    </script>
  </head>
  <body>
    <div class="container-fluid">
        <p id="mensagem"></p>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Startar Servidor PaaS" id="btnEnviarId" >
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Ligar Led " id="btnLigarLed" >
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Desligar Led" id="btnDeslLed" >
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Ligar Rele " id="btnLigarRele" >
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Desligar Rele" id="btnDeslRele" >        
        <p id="log"></p>
        <p id="foot"><a href="http://www.juscilan.com">2016 © - juscilan.com‎</a></p>
    </div>
  </body>
</html>