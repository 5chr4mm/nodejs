<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src=/socket.io/socket.io.js></script>
    <script src=https://code.jquery.com/jquery-1.9.1.min.js></script>
    <script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script>
        /*
        Script em Js NodeJs Adaptado por Juscilan Moreto
        Responsavel por implementar a parte client do socket.io 
        2016 © - juscilan.com‎
        */
        
        // Iniciando Socket Client
        var socket = io.connect();
        var isServ ;
        var adressLocal = 'http://localhost:3012';
        var adressWeb   = 'http://skt-test.herokuapp.com/';
        //var adressWeb   = 'http://localhost:3000';
        
        //Objeto interno de acoes a serem feitas no embarcado
        function ObjAcoes(ledon,ledoff,relon,reloff){
             this.ledon     = ledon 
            ,this.ledoff    = ledoff
            ,this.relon     = relon
            ,this.reloff    = reloff             
        };         
        
        //Objeto post Ajax
        function objPost (url,data) {
             this.url       = url
            ,this.data      = data
        }        
        
        //isServer é emitido pelo socket.io no load da pagina
        socket.on('isServer', function(objSocketidClient){

            //se eu ja tiver a sessionid gravada trata-se de um client    
            if(objSocketidClient.sessionid){
                $('#btnEnviarId').hide();
                
                $('#btnLigarLed').show();
                $('#btnDeslLed').show();
                $('#btnLigarRele').show();
                $('#btnDeslRele').show();               
                
                $('#mensagem').show(); 
                $('#mensagem').css("color","#0000FF"); 
                $('#mensagem').html('Instância client remoto </br> Execute uma ação abaixo:');
                isServ = false;  
            }else{
                $('#btnEnviarId').show();
            };
        
        });  

        // Ping-pong utilizado para manter a conexão com o PaaS    
        socket.on('pong', function(){
            
            $('#mensagem').show(); 
            
            if(isServ){
                socket.emit('ping', {});
                var objpost = new objPost(adressWeb,{"sessionid":socket.id})
                enviaPost(objpost);
            }

        });             

        // Executa a ação de resposta
        socket.on('ExecActionRes', function(dataAction){
            //Aqui eu comparo se estou na instancia isServ e se tenho dataAction
            if(isServ && dataAction){
                var objpost = new objPost(adressLocal,dataAction)
                enviaPost(objpost);
            };      
        });
        
        //Envia um post 
        function enviaPost(dataPost){
            
            var objForPost = {
                url: dataPost.url,
                type: "POST",
                data: JSON.stringify(dataPost.data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
            };
            $.ajax (objForPost);            
        }
    
        //Jquery onload
        $(function(){
            
            $('#btnEnviarId').click(function(){
                socket.emit('ping', {});
                isServ = true;
                $('#btnEnviarId').hide();
                return false;
            });

            //Acoes click botao    
            $('#btnLigarLed').click(function(){
                var objacoes = new ObjAcoes(true,false,false,false);

                socket.emit('ExecAction', objacoes);
                return false;
            }); 
            
            $('#btnDeslLed').click(function(){
                var objacoes = new ObjAcoes(false,true,false,false);

                socket.emit('ExecAction', objacoes);
                return false;
            });
            
            $('#btnLigarRele').click(function(){
                var objacoes = new ObjAcoes(false,false,true,false);

                socket.emit('ExecAction', objacoes);
                return false;
            }); 
            
            $('#btnDeslRele').click(function(){
                var objacoes = new ObjAcoes(false,false,false,true);

                socket.emit('ExecAction', objacoes);
                return false;
            });
            
            //Inicia os elementos html load
            $('#btnEnviarId').hide();

            $('#btnLigarLed').hide();
            $('#btnDeslLed').hide();
            $('#btnLigarRele').hide();
            $('#btnDeslRele').hide();

            $('#mensagem').css("color","#FF0000");
            $('#mensagem').html('Instância bridge não fechar essa aba e nem recarregar. </br> App ponte socket rodando...');  

        });
       
            
    </script>
  </head>
  <body>
    <div class="container-fluid">
        <p id="mensagem"></p>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Startar Servidor PaaS" id="btnEnviarId" >
        </br>
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Ligar Led " id="btnLigarLed" >
        </br>
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Desligar Led" id="btnDeslLed" >
        </br>
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Ligar Rele " id="btnLigarRele" >
        </br>
        </br>
        <input type="button" class="btn btn-primary btn-large" style="width:100%" value="Desligar Rele" id="btnDeslRele" >        
        <p id="log"></p>
        <p id="foot"><a href="http://www.juscilan.com">2016 © - juscilan.com‎</a></p>
    </div>
  </body>
</html>