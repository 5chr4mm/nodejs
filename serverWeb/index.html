<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src=/socket.io/socket.io.js></script>
    <script src=https://code.jquery.com/jquery-1.9.1.min.js></script>
    <script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script>
        
        var adress = 'http://skt-test.herokuapp.com/';
        var adressLocal = 'http://localhost:3012';
        
        var socket = io(adress);
        var lstrgSocketidClient;
        
        
        //Se já foi gravado o SocketidClient eu escondo o botão
        socket.on('lbolSocketidClient', function(objSocketidClient){

        if(objSocketidClient.lstrgSocketServer){
            $('#btnEnviarId').hide();
            $('#btnLigar').show();
            $('#mensagem').text('Instância client remoto Execute uma ação abaixo:');  

        };
        
        });    
    
        socket.on('ligar', function(objSocketidClient){
        lstrgSocketidClient = objSocketidClient.lstrgSocketServer;
        
        //Aqui é o pulo do gato!
        //Eu comparo se o socketIdClient gravado é da master
        //Se for, fechou! eu dou um post para um serviço local RaspBerry
        //Que aciona qualquer dispositivo!

        if(socket.id === lstrgSocketidClient){
            // envia um post maroto local service node.js ajax
            $('#log').html($('#log').html() + '<br>' + 'Acendeu ' + Date());
            
            $.ajax ({
                url: adressLocal,
                type: "POST",
                data: JSON.stringify({data:"test"}),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function(lblLigou){
                    if(lblLigou.acendeu)
                        $('#log').html($('#log').html() + '<br>' + 'Acendeu ' + Date());
                }
            });  
                         
            };      
        }); 
    
        socket.connect(adress, {
            'reconnect': true,
            'reconnection delay': 500,
            'max reconnection attempts': 10
        });   
    
        $(function(){
            $('#btnEnviarId').click(function(){
                socket.emit('setIdServer', {'socketIdClient':socket.id});
                $('#btnEnviarId').hide(); //.attr('disabled', 'disabled');
                alert('Nao feche esta aba do seu navegador!');
                return false;
            });

            $('#btnLigar').click(function(){
                socket.emit('ligar', socket.id);
                return false;
            }); 
            
            $('#btnLigar').hide();   
            $('#mensagem').text('Instância client/server não fechar essa aba do navegador. App socket rodando...');  
        
        });
    
    </script>
  </head>
  <body>
    <div class="container-fluid">
        <p id="mensagem"></p>
        <input type="button" class="btn btn-primary btn-large" value="Autenticar id servidor" id="btnEnviarId" >
        <input type="button" class="btn btn-primary btn-large" value="Ligar" id="btnLigar" >  
        <p id="log"></p>
    </div>
  </body>
</html>